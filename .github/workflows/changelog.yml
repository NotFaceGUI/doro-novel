name: Generate changelog
on:
  release:
    types: [created, edited]

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate changelog
        uses: BobAnkh/auto-generate-changelog@v1.3.0
        with:
          REPO_NAME: 'NotFaceGUI/doro-novel'
          ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PATH: '/CHANGELOG.md'
          COMMIT_MESSAGE: 'docs(changelog): update release notes'
          TYPE_MAPPING: '{"feat":"æ–°åŠŸèƒ½","fix":"Bugä¿®å¤","docs":"æ–‡æ¡£æ›´æ–°","style":"æ ·å¼è°ƒæ•´","refactor":"ä»£ç é‡æ„","perf":"æ€§èƒ½ä¼˜åŒ–","test":"æµ‹è¯•ç›¸å…³","chore":"æ„å»º/å·¥å…·é“¾","ci":"CIé…ç½®","build":"æ„å»ºç³»ç»Ÿ"}'

      - name: Update Release with Changelog
        if: github.event.action == 'published'
        run: |
          # è·å–å½“å‰ Release ä¿¡æ¯
          RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/NotFaceGUI/doro-novel/releases/tags/${{ github.event.release.tag_name }}" | \
            jq -r '.id')
          
          # è¯»å–ç”Ÿæˆçš„ CHANGELOG å†…å®¹ï¼ˆè·å–æœ€æ–°ç‰ˆæœ¬çš„éƒ¨åˆ†ï¼‰
          if [ -f "CHANGELOG.md" ]; then
            # æå–æœ€æ–°ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
            CHANGELOG_CONTENT=$(awk '/^## \[/{if(NR>1) exit} /^## \[/{flag=1; next} flag' CHANGELOG.md)
            
            # æ„å»ºæ–°çš„ Release Body
            NEW_BODY="## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ

          è¿™æ˜¯ Doro Novel ${{ github.event.release.tag_name }} çš„å‘å¸ƒç‰ˆæœ¬ã€‚

          ### ğŸ“‹ å˜æ›´æ—¥å¿—
          $CHANGELOG_CONTENT

          ### ğŸ“¦ ä¸‹è½½
          è¯·ä»ä¸‹æ–¹çš„ Assets ä¸­ä¸‹è½½é€‚åˆæ‚¨æ“ä½œç³»ç»Ÿçš„å®‰è£…åŒ…ã€‚

          ---
          > ğŸ’¡ æç¤ºï¼šå®Œæ•´çš„å˜æ›´å†å²è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/NotFaceGUI/doro-novel/blob/main/CHANGELOG.md) æ–‡ä»¶"
            
            # æ›´æ–° Release
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/NotFaceGUI/doro-novel/releases/$RELEASE_ID" \
              -d "{\"body\": $(echo \"$NEW_BODY\" | jq -Rs .)}"
          fi
        shell: bash