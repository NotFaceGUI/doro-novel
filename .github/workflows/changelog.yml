name: Generate changelog
on:
  release:
    types: [created, edited]

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate changelog
        uses: BobAnkh/auto-generate-changelog@v1.3.0
        with:
          REPO_NAME: 'NotFaceGUI/doro-novel'
          ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PATH: '/CHANGELOG.md'
          COMMIT_MESSAGE: 'docs(changelog): update release notes'
          TYPE_MAPPING: '{"feat":"新功能","fix":"Bug修复","docs":"文档更新","style":"样式调整","refactor":"代码重构","perf":"性能优化","test":"测试相关","chore":"构建/工具链","ci":"CI配置","build":"构建系统"}'

      - name: Update Release with Changelog
        if: github.event.action == 'published'
        run: |
          # 获取当前 Release 信息
          RELEASE_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/NotFaceGUI/doro-novel/releases/tags/${{ github.event.release.tag_name }}" | \
            jq -r '.id')
          
          # 读取生成的 CHANGELOG 内容（获取最新版本的部分）
          if [ -f "CHANGELOG.md" ]; then
            # 提取最新版本的变更内容
            CHANGELOG_CONTENT=$(awk '/^## \[/{if(NR>1) exit} /^## \[/{flag=1; next} flag' CHANGELOG.md)
            
            # 构建新的 Release Body
            NEW_BODY="## 🎉 新版本发布

          这是 Doro Novel ${{ github.event.release.tag_name }} 的发布版本。

          ### 📋 变更日志
          $CHANGELOG_CONTENT

          ### 📦 下载
          请从下方的 Assets 中下载适合您操作系统的安装包。

          ---
          > 💡 提示：完整的变更历史请查看 [CHANGELOG.md](https://github.com/NotFaceGUI/doro-novel/blob/main/CHANGELOG.md) 文件"
            
            # 更新 Release
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/NotFaceGUI/doro-novel/releases/$RELEASE_ID" \
              -d "{\"body\": $(echo \"$NEW_BODY\" | jq -Rs .)}"
          fi
        shell: bash